{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-lg-10 offset-lg-1">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <h1 class="h4 mb-1">{{ task.title }}</h1>
            <p class="text-muted mb-0">{{ task.description }}</p>
          </div>
          <div class="text-nowrap">
            {% if task.extensions and task.extensions|length %}
              {% for ext in task.extensions %}
                <span class="badge text-bg-light border">{{ ext }}</span>
              {% endfor %}
            {% else %}
              <span class="badge text-bg-light border">Any file</span>
            {% endif %}
          </div>
        </div>

        <div class="alert alert-info py-2 mt-3">{{ task.guide }}</div>

        <form id="upload-form" class="mb-3" method="POST" enctype="multipart/form-data" onsubmit="return false;">
          <input type="hidden" id="task-slug" value="{{ task_slug }}">
          <div id="drop-area" class="drop-area mb-3 p-5 text-center">
            <div class="mb-2 fs-2">üìÅ</div>
            <div id="drop-text" class="fw-medium">Drag & drop a file here or <a href="#" id="browse-link">browse</a></div>
            <div class="small text-muted mt-2" id="file-hint">
              Max 20MB ¬∑ {% if task.extensions and task.extensions|length %}Allowed: {{ task.extensions|join(', ') }}{% else %}Any type{% endif %}
            </div>
            <!-- accept is set server-side for the OS dialog -->
            <input id="file-input" type="file" style="display:none" {% if task.extensions and task.extensions|length %}accept="{{ task.extensions|join(',') }}"{% endif %}>
            <div id="selected-file" class="mt-3 text-truncate"></div>
          </div>

          <div class="d-flex gap-2">
            <button id="convert-btn" class="btn btn-primary">Convert to Markdown</button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back</a>
          </div>
        </form>

        <!-- Progress UI -->
        <div id="progress-wrap" class="mt-4 d-none">
          <div class="mb-2 small text-muted" id="progress-label">Uploading‚Ä¶</div>
          <div class="progress" role="progressbar" aria-label="Upload progress" aria-valuemin="0" aria-valuemax="100">
            <div id="upload-bar" class="progress-bar" style="width:0%">0%</div>
          </div>
          <div class="progress mt-3">
            <div id="process-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Processing‚Ä¶</div>
          </div>
        </div>

        <!-- Results -->
        <div id="result-panel" class="mt-4 d-none">
          <ul class="nav nav-tabs" id="viewTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab">Raw Markdown</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">Preview</button>
            </li>
          </ul>
          <div class="tab-content border-start border-end border-bottom p-3 rounded-bottom">
            <div class="tab-pane fade show active" id="raw" role="tabpanel" tabindex="0">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="small text-muted" id="result-filename"></div>
                <div>
                  <button id="copy-btn" class="btn btn-sm btn-outline-secondary">üìã Copy</button>
                  <form id="download-form" method="POST" action="{{ url_for('download') }}" class="d-inline">
                    <input type="hidden" name="markdown" id="download-markdown">
                    <input type="hidden" name="name" id="download-name" value="converted.md">
                    <button class="btn btn-sm btn-primary">üíæ Download .md</button>
                  </form>
                </div>
              </div>
              <textarea id="markdown-output" class="form-control font-mono" rows="14" readonly></textarea>
            </div>
            <div class="tab-pane fade" id="preview" role="tabpanel" tabindex="0">
              <article class="markdown-body" id="markdown-preview"></article>
            </div>
          </div>
        </div>

        <div id="error-box" class="alert alert-danger mt-3 d-none" role="alert"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
